<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visualizaci칩n de Conteo por Pa칤s (Bootstrap)</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Plotly.js para la gr치fica -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
    
    <style>
        body { background-color: #f8f9fa; }
        .card-header { background-color: #e50914 !important; } /* Rojo Netflix */
    </style>
</head>
<body>

    <div class="container-fluid mt-4">
        <div class="row justify-content-center">
            
            <!-- Contenedor principal de la gr치fica -->
            <div class="col-lg-10">
                <div class="card shadow">
                    <div class="card-header text-white">
                        <h3 class="m-0 text-center">游늵 Conteo de T칤tulos por Pa칤s (Top 20)</h3>
                    </div>
                    <div class="card-body">
                        <!-- Contenedor donde se renderizar치 el gr치fico de Plotly -->
                        <div id="country-bar-chart" style="width: 100%; height: 550px;">
                            <div class="text-center p-5">Cargando datos del Backend...</div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Bootstrap JS (Al final del body) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 춰IMPORTANTE! Hemos a침adido /api a la URL base.
        const BACKEND_URL = 'http://127.0.0.1:5000/api'; 

        // --- FUNCI칍N PRINCIPAL: DIBUJAR EL GR츼FICO DE BARRAS ---
        async function drawBarChart() {
            const container = document.getElementById('country-bar-chart');
            
            try {
                // La URL ahora ser치: http://127.0.0.1:5000/api/country-counts
                const response = await fetch(`${BACKEND_URL}/country-counts`);
                
                if (!response.ok) {
                    // Muestra el error espec칤fico que caus칩 el fallo
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Estado: ${response.status}. Respuesta: ${errorText}`);
                }

                const data = await response.json();
                
                // 2. Tomar solo los 20 pa칤ses con m치s contenido
                const top20Data = data.slice(0, 20);
                
                // 3. Preparar los datos para Plotly
                const countries = top20Data.map(item => item.country).reverse(); 
                const counts = top20Data.map(item => item.count).reverse();
                
                // 4. Configuraci칩n del Gr치fico de Barras
                const trace = {
                    x: counts,
                    y: countries,
                    type: 'bar',
                    orientation: 'h', 
                    marker: {
                        color: 'rgb(220, 20, 60)', 
                        opacity: 0.9
                    }
                };

                const layout = {
                    title: 'Distribuci칩n de T칤tulos por Pa칤s (Top 20)',
                    xaxis: {
                        title: 'Cantidad de T칤tulos',
                        automargin: true 
                    },
                    yaxis: {
                        title: 'Pa칤s de Producci칩n',
                        automargin: true 
                    },
                    margin: { l: 150, r: 20, t: 50, b: 50 } 
                };

                // 5. Dibujar el gr치fico
                Plotly.newPlot(container, [trace], layout);
                
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">
                    <strong>Error de Conexi칩n:</strong> No se pudo obtener datos del backend.<br>
                    Verifica que el servidor Flask est칠 activo en <code>http://127.0.0.1:5000</code>.<br>
                    Detalle: ${error.message}
                </div>`;
                console.error('Fetch error:', error);
            }
        }

        // Cargar el gr치fico al iniciar la p치gina
        window.onload = drawBarChart;
    </script>

</body>
</html>
