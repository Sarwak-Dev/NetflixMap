<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Grafico Netflix</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />

  <link rel="stylesheet" href="styles/main.css">
  
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> 
</head>
<body>

    <div class="container-fluid mt-4">
        <div class="row justify-content-start mb-3">
             <div class="col-lg-10 offset-lg-1">
                <a href="index.html" class="btn btn-outline-light text-white">
                    ‚Üê Volver al Inicio
                </a>
            </div>
        </div>
        
        <div class="row justify-content-center">
            
            <div class="col-lg-10">
                <div class="card shadow">
                    <div class="card-header bg-dark text-white d-flex align-items-center">
                        <h3 class="m-0">üìä Conteo de T√≠tulos por Pa√≠s (Top 20)</h3>
                    </div>
                    <div class="card-body">
                        <div id="country-bar-chart" style="width: 100%; height: 550px;">
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const BACKEND_URL = 'http://127.0.0.1:5000/api'; 

        // --- FUNCI√ìN PRINCIPAL: DIBUJAR EL GR√ÅFICO DE BARRAS ---
        async function drawBarChart() {
            const container = document.getElementById('country-bar-chart');
            
            try {
                // Llama al Endpoint 1: /api/country-counts
                const response = await fetch(`${BACKEND_URL}/country-counts`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! Estado: ${response.status}. Respuesta: ${errorText}`);
                }

                const data = await response.json();
                
                // 2. Tomar solo los 20 pa√≠ses con m√°s contenido
                const top20Data = data.slice(0, 20);
                
                // 3. Preparar los datos para Plotly
                // Invertimos el orden para que la barra m√°s larga quede arriba
                const countries = top20Data.map(item => item.country).reverse(); 
                const counts = top20Data.map(item => item.count).reverse();
                
                // 4. Configuraci√≥n del Gr√°fico de Barras
                const trace = {
                    x: counts,
                    y: countries,
                    type: 'bar',
                    orientation: 'h', 
                    marker: {
                        color: 'rgb(220, 20, 60)', // Rojo de Netflix
                        opacity: 0.9
                    }
                };

                const layout = {
                    title: 'Distribuci√≥n de T√≠tulos por Pa√≠s (Top 20)',
                    xaxis: {
                        title: 'Cantidad de T√≠tulos',
                        automargin: true 
                    },
                    yaxis: {
                        title: 'Pa√≠s de Producci√≥n',
                        automargin: true 
                    },
                    // Ajustamos el margen izquierdo para etiquetas largas de pa√≠s
                    margin: { l: 150, r: 20, t: 50, b: 50 } 
                };

                // 5. Dibujar el gr√°fico
                Plotly.newPlot(container, [trace], layout);
                
            } catch (error) {
                // Muestra un error legible si falla la conexi√≥n
                container.innerHTML = `<div class="alert alert-danger">
                    <strong>Error de Conexi√≥n:</strong> No se pudo obtener datos del backend.<br>
                    Verifica que el servidor Flask est√© activo en <code>http://127.0.0.1:5000</code>.<br>
                    Detalle: ${error.message}
                </div>`;
                console.error('Fetch error:', error);
            }
        }

        // Cargar el gr√°fico al iniciar la p√°gina
        window.onload = drawBarChart;
    </script>

</body>
</html>